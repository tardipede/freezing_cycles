---
title: "2. Long term freezing vs. freezing cycles"
author: "Matteo Vecchi"
date: "`r Sys.Date()`"
editor_options:
  chunk_output_type: console
output: 
  workflowr::wflow_html:
    code_folding: hide 
bibliography: bibliography.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, message = FALSE}
library(tidyverse)
library(dplyr)
library(readxl)  # To read from excel files
library(R2jags)
library(ggplot2)
library(patchwork)
library(DT)
library(xfun)          # Download file from html report
library(ape)
library(phytools)
library(svglite)
```

We will test if there is a relationship between the resistence to freeze-thaw cycles and the resistence to long term freezing. Due to the low number of species tested, and the presence of a phylogenetic structure in both variables, we will use the simplest possible way that is testing the relationship between Phylogenetic Indipendent Contrasts (PIC).  

## Data preparation

```{r echo=T}
data_comparison_freezing = read_xlsx("./data/data_freezing.xlsx", sheet = "data_longterm") %>% mutate(p_long = as.numeric(survival)/as.numeric(total)) %>% merge(read.table("./output/means_cycles.txt", header=T)) %>% column_to_rownames(var = "species_code") %>% filter(complete.cases(.))
rownames(data_comparison_freezing) = data_comparison_freezing$species
```

We need now to load the phylogenetic tree.
```{r echo=T, message = FALSE, warning = FALSE}
tree = chronos(read.nexus("./data/tree.nex"))

# As not all species were used for the long term freezing, we have to drop the unused ones from the phylogenetic tree
tree = drop.tip(tree, tip = tree$tip.label[!(tree$tip.label %in% rownames(data_comparison_freezing))])

data_comparison_freezing = data_comparison_freezing[rownames(data_comparison_freezing) %in% tree$tip.label,]

```

Plot the phylogenetic trees with mapped the two characters face to face.

```{r echo=T}
vect.M = data_comparison_freezing$M
names(vect.M) = rownames(data_comparison_freezing)
objM = contMap(tree,vect.M,plot=FALSE, method="anc.ML", lims = c(0,30))

vect.p = data_comparison_freezing$p_long
names(vect.p) = rownames(data_comparison_freezing)
objp = contMap(tree,vect.p,plot=FALSE, method="anc.ML", lims = c(0,1))


par(mfrow=c(1,2))
plot(objM,lwd=7,ftype="reg",xlim=c(-0.2,1.2),legend=0.5, fsize=0.75)
plot(objp,lwd=7,direction="leftwards",ftype="off",xlim=c(-0.2,1.2),
    legend=0.5)
    
svglite("./output/M_vs_plong_plot.svg", width = 6, height = 6) # save the plot
par(mfrow=c(1,2))
plot(objM,lwd=7,ftype="reg",xlim=c(-0.2,1.2),legend=0.5)
plot(objp,lwd=7,direction="leftwards",ftype="off",xlim=c(-0.2,1.2),
    legend=0.5)
dev.off()
```

Download the plot in svg format
```{r echo=FALSE}
embed_file('./output/M_vs_plong_plot.svg')
```


Test the correlation (corrected by phylogeny) between freeze-thaw cycles tolerance and long term freezing tolerance
```{r echo=T}
mat.chars = data_comparison_freezing[,c(3,5)] %>% drop_na() %>% mutate(p_long = scale(p_long), M = scale(M)) %>% as.matrix()

## calculate phylogenetic indipendent contrasts
M_pic = pic(mat.chars[,1],tree)
plong_pic = pic(mat.chars[,2],tree)

lm_pic = lm(M_pic ~ plong_pic -1) # Regression by the origin
plot(M_pic ~ plong_pic, pch=19,
     xlab="Long term freezing resistance PIC",
            ylab="Freeze-thaw resistance PIC")

a_pic = anova(lm_pic)
``` 

The p-value of the correlation between tolerance to freeze-thaw cycles and long term survival (accounting for shared evolutionary history) is `r round(a_pic[[5]][1],3)`.
